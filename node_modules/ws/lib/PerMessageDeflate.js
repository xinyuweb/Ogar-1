function PerMessageDeflate(e,t){if(this instanceof PerMessageDeflate==!1)throw new TypeError("Classes can't be function-called");this._options=e||{},this._isServer=!!t,this._inflate=null,this._deflate=null,this.params=null}var zlib=require("zlib"),AVAILABLE_WINDOW_BITS=[8,9,10,11,12,13,14,15],DEFAULT_WINDOW_BITS=15,DEFAULT_MEM_LEVEL=8;PerMessageDeflate.extensionName="permessage-deflate",PerMessageDeflate.prototype.offer=function(){var e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e},PerMessageDeflate.prototype.accept=function(e){e=this.normalizeParams(e);var t;return t=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params=t,t},PerMessageDeflate.prototype.cleanup=function(){this._inflate&&(this._inflate.writeInProgress?this._inflate.pendingClose=!0:(this._inflate.close&&this._inflate.close(),this._inflate=null)),this._deflate&&(this._deflate.writeInProgress?this._deflate.pendingClose=!0:(this._deflate.close&&this._deflate.close(),this._deflate=null))},PerMessageDeflate.prototype.acceptAsServer=function(e){var t={},i=e.some(function(e){return t={},this._options.serverNoContextTakeover===!1&&e.server_no_context_takeover||this._options.serverMaxWindowBits===!1&&e.server_max_window_bits||"number"==typeof this._options.serverMaxWindowBits&&"number"==typeof e.server_max_window_bits&&this._options.serverMaxWindowBits>e.server_max_window_bits||"number"==typeof this._options.clientMaxWindowBits&&!e.client_max_window_bits?void 0:((this._options.serverNoContextTakeover||e.server_no_context_takeover)&&(t.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(t.client_no_context_takeover=!0),this._options.clientNoContextTakeover!==!1&&e.client_no_context_takeover&&(t.client_no_context_takeover=!0),"number"==typeof this._options.serverMaxWindowBits?t.server_max_window_bits=this._options.serverMaxWindowBits:"number"==typeof e.server_max_window_bits&&(t.server_max_window_bits=e.server_max_window_bits),"number"==typeof this._options.clientMaxWindowBits?t.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits!==!1&&"number"==typeof e.client_max_window_bits&&(t.client_max_window_bits=e.client_max_window_bits),!0)},this);if(!i)throw new Error("Doesn't support the offered configuration");return t},PerMessageDeflate.prototype.acceptAsClient=function(e){var t=e[0];if(null!=this._options.clientNoContextTakeover&&this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Invalid value for "client_no_context_takeover"');if(null!=this._options.clientMaxWindowBits){if(this._options.clientMaxWindowBits===!1&&t.client_max_window_bits)throw new Error('Invalid value for "client_max_window_bits"');if("number"==typeof this._options.clientMaxWindowBits&&(!t.client_max_window_bits||t.client_max_window_bits>this._options.clientMaxWindowBits))throw new Error('Invalid value for "client_max_window_bits"')}return t},PerMessageDeflate.prototype.normalizeParams=function(e){return e.map(function(e){return Object.keys(e).forEach(function(t){var i=e[t];if(i.length>1)throw new Error("Multiple extension parameters for "+t);switch(i=i[0],t){case"server_no_context_takeover":case"client_no_context_takeover":if(i!==!0)throw new Error("invalid extension parameter value for "+t+" ("+i+")");e[t]=!0;break;case"server_max_window_bits":case"client_max_window_bits":if("string"==typeof i&&(i=parseInt(i,10),!~AVAILABLE_WINDOW_BITS.indexOf(i)))throw new Error("invalid extension parameter value for "+t+" ("+i+")");if(!this._isServer&&i===!0)throw new Error("Missing extension parameter value for "+t);e[t]=i;break;default:throw new Error("Not defined extension parameter ("+t+")")}},this),e},this)},PerMessageDeflate.prototype.decompress=function(e,t,i){function n(e){s(),i(e)}function o(e){l.push(e)}function s(){_._inflate&&(_._inflate.removeListener("error",n),_._inflate.removeListener("data",o),_._inflate.writeInProgress=!1,(t&&_.params[r+"_no_context_takeover"]||_._inflate.pendingClose)&&(_._inflate.close&&_._inflate.close(),_._inflate=null))}var r=this._isServer?"client":"server";if(!this._inflate){var a=this.params[r+"_max_window_bits"];this._inflate=zlib.createInflateRaw({windowBits:"number"==typeof a?a:DEFAULT_WINDOW_BITS})}this._inflate.writeInProgress=!0;var _=this,l=[];this._inflate.on("error",n).on("data",o),this._inflate.write(e),t&&this._inflate.write(new Buffer([0,0,255,255])),this._inflate.flush(function(){s(),i(null,Buffer.concat(l))})},PerMessageDeflate.prototype.compress=function(e,t,i){function n(e){s(),i(e)}function o(e){l.push(e)}function s(){_._deflate&&(_._deflate.removeListener("error",n),_._deflate.removeListener("data",o),_._deflate.writeInProgress=!1,(t&&_.params[r+"_no_context_takeover"]||_._deflate.pendingClose)&&(_._deflate.close&&_._deflate.close(),_._deflate=null))}var r=this._isServer?"server":"client";if(!this._deflate){var a=this.params[r+"_max_window_bits"];this._deflate=zlib.createDeflateRaw({flush:zlib.Z_SYNC_FLUSH,windowBits:"number"==typeof a?a:DEFAULT_WINDOW_BITS,memLevel:this._options.memLevel||DEFAULT_MEM_LEVEL})}this._deflate.writeInProgress=!0;var _=this,l=[];this._deflate.on("error",n).on("data",o),this._deflate.write(e),this._deflate.flush(function(){s();var e=Buffer.concat(l);t&&(e=e.slice(0,e.length-4)),i(null,e)})},module.exports=PerMessageDeflate;