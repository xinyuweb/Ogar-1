function Sender(e,t){if(this instanceof Sender==!1)throw new TypeError("Classes can't be function-called");events.EventEmitter.call(this),this._socket=e,this.extensions=t||{},this.firstFragment=!0,this.compress=!1,this.messageHandlers=[],this.processing=!1}function writeUInt16BE(e,t){this[t]=(65280&e)>>8,this[t+1]=255&e}function writeUInt32BE(e,t){this[t]=(4278190080&e)>>24,this[t+1]=(16711680&e)>>16,this[t+2]=(65280&e)>>8,this[t+3]=255&e}function getArrayBuffer(e){for(var t=new Uint8Array(e.buffer||e),r=e.byteLength||e.length,n=e.byteOffset||0,i=new Buffer(r),s=0;r>s;++s)i[s]=t[n+s];return i}function getRandomMask(){return new Buffer([~~(255*Math.random()),~~(255*Math.random()),~~(255*Math.random()),~~(255*Math.random())])}var events=require("events"),util=require("util"),EventEmitter=events.EventEmitter,ErrorCodes=require("./ErrorCodes"),bufferUtil=require("./BufferUtil").BufferUtil,PerMessageDeflate=require("./PerMessageDeflate");util.inherits(Sender,events.EventEmitter),Sender.prototype.close=function(e,t,r,n){if("undefined"!=typeof e&&("number"!=typeof e||!ErrorCodes.isValidErrorCode(e)))throw new Error("first argument must be a valid error code number");e=e||1e3;var i=new Buffer(2+(t?Buffer.byteLength(t):0));writeUInt16BE.call(i,e,0),i.length>2&&i.write(t,2);var s=this;this.messageHandlers.push(function(e){s.frameAndSend(8,i,!0,r),e(),"function"==typeof n&&n()}),this.flush()},Sender.prototype.ping=function(e,t){var r=t&&t.mask,n=this;this.messageHandlers.push(function(t){n.frameAndSend(9,e||"",!0,r),t()}),this.flush()},Sender.prototype.pong=function(e,t){var r=t&&t.mask,n=this;this.messageHandlers.push(function(t){n.frameAndSend(10,e||"",!0,r),t()}),this.flush()},Sender.prototype.send=function(e,t,r){var n=t&&t.fin===!1?!1:!0,i=t&&t.mask,s=t&&t.compress,f=t&&t.binary?2:1;this.firstFragment===!1?(f=0,s=!1):(this.firstFragment=!1,this.compress=s),n&&(this.firstFragment=!0);var o=this.compress,a=this;this.messageHandlers.push(function(t){a.applyExtensions(e,n,o,function(e,o){return e?void("function"==typeof r?r(e):a.emit("error",e)):(a.frameAndSend(f,o,n,i,s,r),void t())})}),this.flush()},Sender.prototype.frameAndSend=function(e,t,r,n,i,s){var f=!1;if(t){Buffer.isBuffer(t)||(f=!0,!t||"undefined"==typeof t.byteLength&&"undefined"==typeof t.buffer?("number"==typeof t&&(t=t.toString()),t=new Buffer(t)):t=getArrayBuffer(t));var o=t.length,a=n?6:2,h=o;o>=65536?(a+=8,h=127):o>125&&(a+=2,h=126);var u=32768>o||n&&!f,c=u?o+a:a,d=new Buffer(c);switch(d[0]=r?128|e:e,i&&(d[0]|=64),h){case 126:writeUInt16BE.call(d,o,2);break;case 127:writeUInt32BE.call(d,0,2),writeUInt32BE.call(d,o,6)}if(n){d[1]=128|h;var l=this._randomMask||(this._randomMask=getRandomMask());if(d[a-4]=l[0],d[a-3]=l[1],d[a-2]=l[2],d[a-1]=l[3],u){bufferUtil.mask(t,l,d,a,o);try{this._socket.write(d,"binary",s)}catch(m){"function"==typeof s?s(m):this.emit("error",m)}}else{bufferUtil.mask(t,l,t,0,o);try{this._socket.write(d,"binary"),this._socket.write(t,"binary",s)}catch(m){"function"==typeof s?s(m):this.emit("error",m)}}}else if(d[1]=h,u){t.copy(d,a);try{this._socket.write(d,"binary",s)}catch(m){"function"==typeof s?s(m):this.emit("error",m)}}else try{this._socket.write(d,"binary"),this._socket.write(t,"binary",s)}catch(m){"function"==typeof s?s(m):this.emit("error",m)}}else try{this._socket.write(new Buffer([e|(r?128:0),0|(n?128:0)].concat(n?[0,0,0,0]:[])),"binary",s)}catch(m){"function"==typeof s?s(m):this.emit("error",m)}},Sender.prototype.flush=function(){if(!this.processing){var e=this.messageHandlers.shift();if(e){this.processing=!0;var t=this;e(function(){t.processing=!1,t.flush()})}}},Sender.prototype.applyExtensions=function(e,t,r,n){r&&e?((e.buffer||e)instanceof ArrayBuffer&&(e=getArrayBuffer(e)),this.extensions[PerMessageDeflate.extensionName].compress(e,t,n)):n(null,e)},module.exports=Sender;