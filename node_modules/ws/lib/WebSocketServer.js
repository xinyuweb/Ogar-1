function WebSocketServer(e,t){if(this instanceof WebSocketServer==!1)return new WebSocketServer(e,t);if(events.EventEmitter.call(this),e=new Options({host:"0.0.0.0",port:null,server:null,verifyClient:null,handleProtocols:null,path:null,noServer:!1,disableHixie:!1,clientTracking:!0,perMessageDeflate:!0}).merge(e),!e.isDefinedAndNonNull("port")&&!e.isDefinedAndNonNull("server")&&!e.value.noServer)throw new TypeError("`port` or a `server` must be provided");var r=this;if(e.isDefinedAndNonNull("port"))this._server=http.createServer(function(e,t){var r=http.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)}),this._server.allowHalfOpen=!1,this._server.listen(e.value.port,e.value.host,t),this._closeServer=function(){r._server&&r._server.close()};else if(e.value.server&&(this._server=e.value.server,e.value.path)){if(this._server._webSocketPaths&&e.value.server._webSocketPaths[e.value.path])throw new Error("two instances of WebSocketServer cannot listen on the same http server path");"object"!=typeof this._server._webSocketPaths&&(this._server._webSocketPaths={}),this._server._webSocketPaths[e.value.path]=1}this._server&&this._server.once("listening",function(){r.emit("listening")}),"undefined"!=typeof this._server&&(this._server.on("error",function(e){r.emit("error",e)}),this._server.on("upgrade",function(e,t,n){var o=new Buffer(n.length);n.copy(o),r.handleUpgrade(e,t,o,function(t){r.emit("connection"+e.url,t),r.emit("connection",t)})})),this.options=e.value,this.path=e.value.path,this.clients=[]}function handleHybiUpgrade(e,t,r,n){var o=function(){try{t.destroy()}catch(e){}};if(t.on("error",o),!e.headers["sec-websocket-key"])return void abortConnection(t,400,"Bad Request");var i=parseInt(e.headers["sec-websocket-version"]);if(-1===[8,13].indexOf(i))return void abortConnection(t,400,"Bad Request");var s=e.headers["sec-websocket-protocol"],a=13>i?e.headers["sec-websocket-origin"]:e.headers.origin,c=Extensions.parse(e.headers["sec-websocket-extensions"]),h=this,l=function(s){var a=e.headers["sec-websocket-key"],l=crypto.createHash("sha1");l.update(a+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),a=l.digest("base64");var d=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+a];"undefined"!=typeof s&&d.push("Sec-WebSocket-Protocol: "+s);var p={};try{p=acceptExtensions.call(h,c)}catch(u){return void abortConnection(t,400,"Bad Request")}if(Object.keys(p).length){var f={};Object.keys(p).forEach(function(e){f[e]=[p[e].params]}),d.push("Sec-WebSocket-Extensions: "+Extensions.format(f))}h.emit("headers",d),t.setTimeout(0),t.setNoDelay(!0);try{t.write(d.concat("","").join("\r\n"))}catch(v){try{t.destroy()}catch(v){}return}var y=new WebSocket([e,t,r],{protocolVersion:i,protocol:s,extensions:p});h.options.clientTracking&&(h.clients.push(y),y.on("close",function(){var e=h.clients.indexOf(y);-1!=e&&h.clients.splice(e,1)})),t.removeListener("error",o),n(y)},d=function(){if("function"==typeof h.options.handleProtocols){var e=(s||"").split(/, */),r=!1;h.options.handleProtocols(e,function(e,n){r=!0,e?l(n):abortConnection(t,401,"Unauthorized")});return void(r||abortConnection(t,501,"Could not process protocols"))}"undefined"!=typeof s?l(s.split(/, */)[0]):l()};if("function"==typeof this.options.verifyClient){var p={origin:a,secure:"undefined"!=typeof e.connection.authorized||"undefined"!=typeof e.connection.encrypted,req:e};if(2==this.options.verifyClient.length)return void this.options.verifyClient(p,function(e,r,n){"undefined"==typeof r&&(r=401),"undefined"==typeof n&&(n=http.STATUS_CODES[r]),e?d():abortConnection(t,r,n)});if(!this.options.verifyClient(p))return void abortConnection(t,401,"Unauthorized")}d()}function handleHixieUpgrade(e,t,r,n){var o=function(){try{t.destroy()}catch(e){}};if(t.on("error",o),this.options.disableHixie)return void abortConnection(t,401,"Hixie support disabled");if(!e.headers["sec-websocket-key2"])return void abortConnection(t,400,"Bad Request");var i=e.headers.origin,s=this,a=function(){var a;a=e.headers["x-forwarded-host"]?e.headers["x-forwarded-host"]:e.headers.host;var c=("https"===e.headers["x-forwarded-proto"]||t.encrypted?"wss":"ws")+"://"+a+e.url,h=e.headers["sec-websocket-protocol"],l=function(r,a){var l=e.headers["sec-websocket-key1"],d=e.headers["sec-websocket-key2"],p=crypto.createHash("md5");[l,d].forEach(function(e){var r=parseInt(e.replace(/[^\d]/g,"")),n=e.replace(/[^ ]/g,"").length;return 0===n||r%n!==0?void abortConnection(t,400,"Bad Request"):(r/=n,void p.update(String.fromCharCode(r>>24&255,r>>16&255,r>>8&255,255&r)))}),p.update(r.toString("binary"));var u=["HTTP/1.1 101 Switching Protocols","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Location: "+c];"undefined"!=typeof h&&u.push("Sec-WebSocket-Protocol: "+h),"undefined"!=typeof i&&u.push("Sec-WebSocket-Origin: "+i),t.setTimeout(0),t.setNoDelay(!0);try{var f=new Buffer(u.concat("","").join("\r\n")),v=new Buffer(p.digest("binary"),"binary"),y=new Buffer(f.length+v.length);f.copy(y,0),v.copy(y,f.length),t.write(y,"binary",function(r){if(!r){var i=new WebSocket([e,t,a],{protocolVersion:"hixie-76",protocol:h});s.options.clientTracking&&(s.clients.push(i),i.on("close",function(){var e=s.clients.indexOf(i);-1!=e&&s.clients.splice(e,1)})),t.removeListener("error",o),n(i)}})}catch(b){try{t.destroy()}catch(b){}return}},d=8;if(r&&r.length>=d){var p=r.slice(0,d),u=r.length>d?r.slice(d):null;l.call(s,p,u)}else{var p=new Buffer(d);r.copy(p,0);var f=r.length,u=null,v=function(e){var r=Math.min(e.length,d-f);0!==r&&(e.copy(p,f,0,r),f+=r,f==d&&(t.removeListener("data",v),r<e.length&&(u=e.slice(r)),l.call(s,p,u)))};t.on("data",v)}};if("function"==typeof this.options.verifyClient){var c={origin:i,secure:"undefined"!=typeof e.connection.authorized||"undefined"!=typeof e.connection.encrypted,req:e};if(2==this.options.verifyClient.length){var s=this;return void this.options.verifyClient(c,function(e,r,n){"undefined"==typeof r&&(r=401),"undefined"==typeof n&&(n=http.STATUS_CODES[r]),e?a.apply(s):abortConnection(t,r,n)})}if(!this.options.verifyClient(c))return void abortConnection(t,401,"Unauthorized")}a()}function acceptExtensions(e){var t={},r=this.options.perMessageDeflate;if(r&&e[PerMessageDeflate.extensionName]){var n=new PerMessageDeflate(r!==!0?r:{},!0);n.accept(e[PerMessageDeflate.extensionName]),t[PerMessageDeflate.extensionName]=n}return t}function abortConnection(e,t,r){try{var n=["HTTP/1.1 "+t+" "+r,"Content-type: text/html"];e.write(n.concat("","").join("\r\n"))}catch(o){}finally{try{e.destroy()}catch(o){}}}var util=require("util"),events=require("events"),http=require("http"),crypto=require("crypto"),Options=require("options"),WebSocket=require("./WebSocket"),Extensions=require("./Extensions"),PerMessageDeflate=require("./PerMessageDeflate"),tls=require("tls"),url=require("url");util.inherits(WebSocketServer,events.EventEmitter),WebSocketServer.prototype.close=function(e){var t=null;try{for(var r=0,n=this.clients.length;n>r;++r)this.clients[r].terminate()}catch(o){t=o}this.path&&this._server._webSocketPaths&&(delete this._server._webSocketPaths[this.path],0==Object.keys(this._server._webSocketPaths).length&&delete this._server._webSocketPaths);try{"undefined"!=typeof this._closeServer&&this._closeServer()}finally{delete this._server}if(e)e(t);else if(t)throw t},WebSocketServer.prototype.handleUpgrade=function(e,t,r,n){if(this.options.path){var o=url.parse(e.url);if(o&&o.pathname!==this.options.path)return}return"undefined"==typeof e.headers.upgrade||"websocket"!==e.headers.upgrade.toLowerCase()?void abortConnection(t,400,"Bad Request"):void(e.headers["sec-websocket-key1"]?handleHixieUpgrade.apply(this,arguments):handleHybiUpgrade.apply(this,arguments))},module.exports=WebSocketServer;